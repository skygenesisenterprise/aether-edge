# =============================================================================
# Aether Edge Device Dockerfile
# Optimized for hardware deployment on Debian 13 (slime)
# =============================================================================
FROM debian:13-slim

# Set environment variables
ENV NODE_ENV=production \
    ENVIRONMENT=device \
    DEBIAN_FRONTEND=noninteractive \
    TZ=UTC

# Set working directory
WORKDIR /opt/aether-edge

# Install system dependencies for hardware devices
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core dependencies
    curl \
    wget \
    ca-certificates \
    gnupg \
    unzip \
    tar \
    gzip \
    # Network tools for device management
    iproute2 \
    iptables \
    net-tools \
    wireguard-tools \
    # Hardware monitoring
    htop \
    lm-sensors \
    # Process management
    supervisor \
    # Time synchronization
    ntpsec-ntpdate \
    # Security
    apparmor-utils \
    # Cleanup
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Create non-root user for security
RUN groupadd -r aether && useradd -r -g aether -d /opt/aether-edge -s /sbin/nologin aether

# Install Node.js 22.x for hardware compatibility
RUN curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy package files
COPY package*.json ./

# Install Node.js dependencies (production only)
RUN npm ci --only=production --no-audit --no-fund && \
    npm cache clean --force

# Copy application source code
COPY --chown=aether:aether . .

# Set build to device version
RUN echo 'export const build = "device" as any;' > server/build.ts && \
    cp tsconfig.device.json tsconfig.json

# Build the application for device deployment
RUN npm run build:pg && \
    mkdir -p /opt/aether-edge/data /opt/aether-edge/logs /opt/aether-edge/config

# Copy device-specific configuration
COPY --chown=aether:aether config/device.example.yml /opt/aether-edge/config/config.yml

# Create supervisor configuration
RUN cat > /etc/supervisor/conf.d/aether-edge.conf << 'EOF'
[program:aether-edge]
command=/usr/bin/node --enable-source-maps dist/server.mjs
directory=/opt/aether-edge
user=aether
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/opt/aether-edge/logs/aether-edge.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
environment=NODE_ENV=production,ENVIRONMENT=device
EOF

# Create device management scripts
RUN cat > /opt/aether-edge/scripts/device-setup.sh << 'EOF'
#!/bin/bash
# Device setup script for Aether Edge
set -e

echo "ðŸ”§ Setting up Aether Edge Device..."

# Create necessary directories
mkdir -p /opt/aether-edge/data /opt/aether-edge/logs /opt/aether-edge/config

# Set proper permissions
chown -R aether:aether /opt/aether-edge

# Generate device ID if not exists
if [ ! -f /opt/aether-edge/config/device-id ]; then
    echo "Generating device ID..."
    cat /proc/sys/kernel/random/uuid | tr -d '\n' > /opt/aether-edge/config/device-id
    chown aether:aether /opt/aether-edge/config/device-id
fi

# Setup WireGuard if needed
if command -v wg >/dev/null 2>&1; then
    echo "ðŸ“¡ WireGuard tools detected"
else
    echo "âš ï¸  WireGuard tools not found - some features may not work"
fi

echo "âœ… Device setup complete"
echo "ðŸ“‹ Device ID: $(cat /opt/aether-edge/config/device-id)"
EOF

RUN cat > /opt/aether-edge/scripts/device-health.sh << 'EOF'
#!/bin/bash
# Device health check script
set -e

echo "ðŸ¥ Aether Edge Device Health Check"

# Check if service is running
if pgrep -f "dist/server.mjs" > /dev/null; then
    echo "âœ… Aether Edge service is running"
else
    echo "âŒ Aether Edge service is not running"
    exit 1
fi

# Check network connectivity
if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
    echo "âœ… Network connectivity OK"
else
    echo "âš ï¸  Network connectivity issues detected"
fi

# Check disk space
DISK_USAGE=$(df /opt/aether-edge | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -lt 80 ]; then
    echo "âœ… Disk usage: ${DISK_USAGE}%"
else
    echo "âš ï¸  High disk usage: ${DISK_USAGE}%"
fi

# Check memory usage
MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
if [ "$MEM_USAGE" -lt 80 ]; then
    echo "âœ… Memory usage: ${MEM_USAGE}%"
else
    echo "âš ï¸  High memory usage: ${MEM_USAGE}%"
fi

echo "ðŸ“‹ Device ID: $(cat /opt/aether-edge/config/device-id 2>/dev/null || echo 'Not set')"
echo "ðŸ”— Dashboard: http://$(hostname -I | awk '{print $1}'):3002"
EOF

# Make scripts executable
RUN chmod +x /opt/aether-edge/scripts/*.sh

# Create device configuration template
RUN cat > /opt/aether-edge/config/device.example.yml << 'EOF'
# Aether Edge Device Configuration
# Optimized for hardware deployment

app:
  mode: device
  dashboard_url: http://localhost:3002
  log_level: info
  device_id: "auto"  # Auto-generate or specify hardware ID

# Device-specific settings
device:
  model: "aether-edge-device"
  manufacturer: "Aether Edge"
  firmware_version: "1.0.0"
  capabilities:
    - hardware-acceleration
    - offline-mode
    - embedded-database
    - wireguard-support
  
# Hardware acceleration settings
hardware:
  crypto_acceleration:
    enabled: true
    driver: "openssl"
  
  watchdog:
    enabled: true
    timeout: 30s
    
  led_indicators:
    power: "/sys/class/leds/power/brightness"
    status: "/sys/class/leds/status/brightness"
    network: "/sys/class/leds/network/brightness"

# Network configuration
network:
  auto_discovery: true
  fallback_connectivity: true
  wireguard:
    enabled: true
    port: 51820

# Database configuration (SQLite for embedded devices)
database:
  type: sqlite
  path: /opt/aether-edge/data/aether-edge.db
  max_size: 100MB

# Storage configuration
storage:
  data_path: /opt/aether-edge/data
  log_path: /opt/aether-edge/logs
  config_path: /opt/aether-edge/config
  max_log_size: 50MB
  log_retention_days: 7

# Security settings
server:
  secret: "CHANGE_THIS_IN_PRODUCTION"
  session_timeout: 24h

# Monitoring and health checks
monitoring:
  enabled: true
  health_check_interval: 60s
  metrics_port: 9090

# Update settings
updates:
  auto_update: false
  check_interval: 24h
  backup_before_update: true

# Flags for device mode
flags:
  require_email_verification: false
  disable_signup_without_invite: true
  disable_user_create_org: true
  allow_raw_resources: true
  enable_integration_api: true
  enable_clients: true
  enable_device_mode: true
EOF

# Expose ports
EXPOSE 3000 3001 3002 51820/udp

# Create entrypoint script
RUN cat > /opt/aether-edge/entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸš€ Starting Aether Edge Device..."

# Run device setup
/opt/aether-edge/scripts/device-setup.sh

# Initialize database if needed
if [ ! -f /opt/aether-edge/data/aether-edge.db ]; then
    echo "ðŸ“Š Initializing database..."
    cd /opt/aether-edge
    sudo -u aether ENVIRONMENT=prod node dist/migrations.mjs
fi

# Start supervisor to manage the service
echo "ðŸ‘¥ Starting service manager..."
exec /usr/bin/supervisord -c /etc/supervisor/supervisord.conf
EOF

RUN chmod +x /opt/aether-edge/entrypoint.sh

# Switch to non-root user
USER aether

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /opt/aether-edge/scripts/device-health.sh

# Set entrypoint
ENTRYPOINT ["/opt/aether-edge/entrypoint.sh"]

# Labels for device management
LABEL maintainer="Aether Edge Team" \
      version="1.0.0" \
      description="Aether Edge - Hardware Device Version" \
      architecture="linux/amd64,linux/arm64" \
      purpose="embedded-device" \
      org.aether-edge.build-type="device" \
      org.aether-edge.os="debian-13-slim"

# Default command
CMD []