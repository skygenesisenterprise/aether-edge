# =============================================================================
# Aether Edge Device Docker Compose
# Optimized for hardware deployment and embedded systems
# =============================================================================
version: '3.8'

services:
  # Aether Edge Device Service
  aether-edge-device:
    build:
      context: .
      dockerfile: Dockerfile.device
    container_name: aether-edge-device
    privileged: true  # Required for WireGuard and hardware access
    network_mode: host  # Direct network access for WireGuard
    volumes:
      # Persistent data storage
      - device_data:/opt/aether-edge/data
      - device_logs:/opt/aether-edge/logs
      - device_config:/opt/aether-edge/config
      # Hardware access (if needed)
      - /sys:/sys:ro
      - /proc:/proc:ro
      - /dev:/dev
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=device
      - TZ=UTC
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/opt/aether-edge/scripts/device-health.sh"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.aether-edge.rule=Host(`localhost`)"
      - "traefik.http.services.aether-edge.loadbalancer.server.port=3002"
      - "org.aether-edge.service.type=device"
      - "org.aether-edge.service.version=1.0.0"

  # Optional: Monitoring for device deployments
  device-monitor:
    image: prom/node-exporter:latest
    container_name: aether-edge-monitor
    pid: host
    network_mode: host
    volumes:
      - /:/host:ro,rslave
      - /sys:/sys:ro
      - /proc:/proc:ro
    command:
      - '--path.rootfs=/host'
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    restart: unless-stopped
    profiles:
      - monitoring

  # Optional: Log aggregation for devices
  device-logs:
    image: fluent/fluent-bit:latest
    container_name: aether-edge-logs
    volumes:
      - device_logs:/var/log/aether-edge:ro
      - ./config/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
    environment:
      - FLUENT_CONF=/fluent-bit/etc/fluent-bit.conf
    restart: unless-stopped
    profiles:
      - logging

volumes:
  device_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/aether-edge/data
  device_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/aether-edge/logs
  device_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/aether-edge/config

networks:
  default:
    driver: bridge