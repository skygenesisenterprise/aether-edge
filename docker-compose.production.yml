name: aether-edge-production
version: '3.8'

services:
  # PostgreSQL Database (Recommended for production)
  postgres:
    image: postgres:17
    container_name: aether-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: aether_edge
      POSTGRES_USER: aether_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - aether-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aether_user -d aether_edge"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  # Redis Cache (Optional but recommended)
  redis:
    image: redis:7-alpine
    container_name: aether-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - aether-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # Main Aether Edge Application
  aether-edge:
    image: aether-edge:production
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
      args:
        BUILD: enterprise
        DATABASE: pg
    container_name: aether-edge-app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - ENVIRONMENT=production
      - DATABASE_URL=postgresql://aether_user:${POSTGRES_PASSWORD}@postgres:5432/aether_edge
      - REDIS_URL=redis://redis:6379
      - APP_LOG_LEVEL=${LOG_LEVEL:-info}
      - SERVER_SECRET=${SERVER_SECRET}
      - APP_DASHBOARD_URL=${DASHBOARD_URL:-https://your-domain.com}
    volumes:
      - ./config:/app/config:ro
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - aether-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'

  # Gerbil WireGuard Gateway
  gerbil:
    image: fosrl/gerbil:latest
    container_name: aether-gerbil
    restart: unless-stopped
    depends_on:
      aether-edge:
        condition: service_healthy
    command:
      - --reachableAt=http://gerbil:3004
      - --generateAndSaveKeyTo=/var/config/key
      - --remoteConfig=http://aether-edge:3001/api/v1/
      - --logLevel=${GERBIL_LOG_LEVEL:-info}
    volumes:
      - ./config:/var/config:rw
      - ./logs/gerbil:/var/log
    networks:
      - aether-network
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    ports:
      - "80:80"
      - "443:443"
      - "51820:51820/udp"
      - "21820:21820/udp"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # Traefik Reverse Proxy
  traefik:
    image: traefik:v3.5
    container_name: aether-traefik
    restart: unless-stopped
    depends_on:
      aether-edge:
        condition: service_healthy
    command:
      - --configFile=/etc/traefik/traefik_config.yml
      - --api.dashboard=true
      - --api.insecure=false
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
      - --accesslog=true
      - --accesslog.filepath=/var/log/traefik/access.log
      - --providers.file.directory=/var/dynamic
      - --providers.file.watch=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    volumes:
      - ./config/traefik:/etc/traefik:ro
      - ./config/traefik/dynamic:/var/dynamic:ro
      - ./letsencrypt:/letsencrypt:rw
      - ./logs/traefik:/var/log:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - aether-network
    ports:
      - "80:80"
      - "443:443"
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # Monitoring (Optional)
  prometheus:
    image: prom/prometheus:latest
    container_name: aether-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - aether-network
    profiles:
      - monitoring
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'

  # Grafana Dashboard (Optional)
  grafana:
    image: grafana/grafana:latest
    container_name: aether-grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    networks:
      - aether-network
    ports:
      - "3000:3000"
    profiles:
      - monitoring
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  aether-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    enable_ipv6: false